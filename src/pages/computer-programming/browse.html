<link rel="stylesheet" href="/CDN/pages/computer-programming/browse.css" type="text/css">

<div id="page-middle-container">
    <h1 style="margin-top: 32px;">Browse Projects</h1>
    
    <div style="margin-top: -40px; text-align: right;">
        <span class="list-tab-btn" id="hot-btn">Hot</span>
        <span class="list-tab-btn" id="recent-btn">Recent</span>
        <span class="list-tab-btn" id="contests-btn"></span>
        <span class="list-tab-btn" id="top-btn">Top</span>
    </div>

    <div style="height: 2px; background-color: rgb(200, 200, 200); margin-bottom: 20px;  margin-top: 20px;"></div>

    <div class="programs-grid"></div>

    <br><br>
    <button id="load-more-btn" class="button">Load More Projects</button>
    <br><br>
    
    <script>
const grid = $(".programs-grid")[0];
let allPrograms = [];
let sort = "";
let page = 0;
        
let Program = $.createComponent("Program", $.html`
    <div class="program">
        <a href="/computer-programming/\{id}" class="program_title program-link">\{title}</a>
        <a href="/computer-programming/\{id}" class="program_thumbnail-wrapper program-link">
            <img src="" alt="Program Thumbnail" class="program_thumbnail">
        </a>
        <div style="display: flex; padding-top: .4rem;">
            <img src="/CDN/images/language-icons/\{type}.png" height="45">
            <div style="margin-left: .3rem;">
                <div class="program_metadata-wrapper">
                    <span class="program_likes">\{likes.length}</span>
                    <span class="program_likes-title">Likes</span>
                    <span> Â· </span>
                    <span class="program_forks">\{forks.length}</span>
                    <span class="program_forks-title">Forks</span>
                </div>
                <div class="program_metadata-wrapper">
                    <a class="author-link" href="/profile/id_\{author.id}">\{author.nickname}</a>
                </div>
            </div>
        </div>
    </div>
`, function(program) {
    let loadIcon = loadIconManager.new(200).addClass("program_thumbnail");
    this.$(".program_thumbnail-wrapper program-link")[0].append(loadIcon);
    
    let img = this.$(".program_thumbnail")[0];
    img.dataset.failed = "false";
    img.css("display: none")
        .attr("src", "/CDN/programs/" + program.id[0].toUpperCase() + "/" + program.id + "/i.jpg")
        .on("error", () => {
            if (img.dataset.failed === "false") {
                img.src = "/CDN/images/404_image.jpg";
            }
            img.dataset.failed = "true";
        })
        .on("load", () => {
            loadIconManager.delete(loadIcon);
            img.css("display: inline");
        });
});

function displayPrograms(programs) {
    programs.forEach(program => Program(program).appendTo(grid));
}

function loadPrograms(sort, page) {
    $.getJSON(`/API/projects?sort=${sort}&page=${page}`, programs => {
        for (var i = 0; i < programs.length; i++) {
            allPrograms.push(programs[i]);
        }
        displayPrograms(programs);
    });
}

function changeSort(newSort) {
    grid.innerHTML = "";
    allPrograms = [];
    page = 0;
    sort = newSort;
    loadPrograms(sort, page++);
}

let hotBtn = $("#hot-btn"),
    recentBtn = $("#recent-btn"),
    topBtn = $("#top-btn");

hotBtn.on("click", e => {
    if (sort !== "hot") {
        hotBtn.css("text-decoration: underline");
        recentBtn.css("text-decoration: none");
        topBtn.css("text-decoration: none");
        changeSort("hot");   
    }
});

recentBtn.on("click", e => {
    if (sort !== "recent") {
        hotBtn.css("text-decoration: none");
        recentBtn.css("text-decoration: underline");
        topBtn.css("text-decoration: none");
        changeSort("recent");   
    }
});

topBtn.on("click", e => {
    if (sort !== "top") {
        hotBtn.css("text-decoration: none");
        recentBtn.css("text-decoration: none");
        topBtn.css("text-decoration: underline");
        changeSort("top");   
    }
});

$("#load-more-btn").css(`
    display: block;
    margin: auto;
`).on("click", () => {
    loadPrograms(sort, page++);
});

// load the hot list
hotBtn.click();

    </script>
</div>
